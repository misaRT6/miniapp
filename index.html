<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Gifts Auction</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    :root {
      --bg-color: #000000;
      --card-bg: #1c1c1e;
      --text-primary: #ffffff;
      --text-secondary: #8e8e93;
      --accent: #007aff; /* System Blue */
      --accent-grad: linear-gradient(135deg, #007aff, #0056b3);
      --success: #32d74b;
      --danger: #ff453a;
      --nav-bg: rgba(28, 28, 30, 0.85);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      padding-bottom: 80px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –º–µ–Ω—é */
    }

    /* --- Typography & Layout --- */
    h1, h2, h3 { margin: 0; font-weight: 600; }
    .container { padding: 16px; }
    .hidden { display: none !important; }
    
    /* --- Header --- */
    .header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px;
      position: sticky; top: 0;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
      z-index: 10;
    }
    .user-info { display: flex; align-items: center; gap: 10px; }
    .avatar { 
      width: 36px; height: 36px; 
      border-radius: 50%; background: var(--accent); 
      display: flex; align-items: center; justify-content: center; font-weight: bold;
    }
    .balance-pill {
      background: rgba(255,255,255,0.1);
      padding: 6px 12px; border-radius: 20px;
      font-size: 14px; display: flex; align-items: center; gap: 6px;
    }

    /* --- Tabs (Bottom Nav) --- */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 70px;
      background: var(--nav-bg);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: space-around; align-items: center;
      z-index: 50;
      padding-bottom: 10px; /* Safe area adjustment */
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center;
      color: var(--text-secondary); font-size: 10px; gap: 4px;
      cursor: pointer; transition: 0.2s;
    }
    .nav-item i { font-size: 24px; }
    .nav-item.active { color: var(--accent); }

    /* --- Cards --- */
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card {
      background: var(--card-bg); border-radius: 16px;
      overflow: hidden; display: flex; flex-direction: column;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .card-img {
      width: 100%; aspect-ratio: 1; object-fit: cover;
      background: #333;
    }
    .card-body { padding: 12px; display: flex; flex-direction: column; gap: 4px; }
    .card-title { font-size: 15px; }
    .card-price { font-size: 13px; color: var(--text-secondary); }
    .card-price b { color: var(--text-primary); font-size: 15px; }
    
    .btn {
      border: none; padding: 10px; border-radius: 10px;
      font-weight: 600; cursor: pointer; text-align: center;
      width: 100%; margin-top: 8px; font-size: 14px;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:active { opacity: 0.8; }
    .btn-outline { background: rgba(255,255,255,0.1); color: #fff; }

    /* --- Wallet Section --- */
    .wallet-card {
      background: linear-gradient(135deg, #1c1c1e 0%, #2c2c2e 100%);
      border-radius: 20px; padding: 24px; text-align: center;
      margin-bottom: 24px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .big-balance { font-size: 36px; font-weight: 700; margin: 10px 0; }
    .wallet-actions { display: flex; gap: 10px; justify-content: center; }
    .action-btn {
      flex: 1; padding: 12px; border-radius: 12px;
      background: rgba(255,255,255,0.1); color: #fff; border: none;
      font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px;
    }

    /* --- Loader --- */
    .loader {
      border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent);
      border-radius: 50%; width: 24px; height: 24px;
      animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- Notification --- */
    #notification {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: #333; color: #fff; padding: 10px 20px;
      border-radius: 30px; font-size: 14px; z-index: 100;
      opacity: 0; pointer-events: none; transition: 0.3s;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
    #notification.show { opacity: 1; top: 30px; }
  </style>
</head>
<body>

  <div id="notification">Action Successful</div>

  <div class="header">
    <div class="user-info">
      <div class="avatar" id="uAvatar">U</div>
      <div style="line-height: 1.2;">
        <div style="font-size: 14px;" id="uName">Loading...</div>
        <div style="font-size: 11px; color: var(--text-secondary);">Online</div>
      </div>
    </div>
    <div class="balance-pill">
      <i class="ri-wallet-3-line"></i>
      <span id="headerBal">0.0</span> TON
    </div>
  </div>

  <div id="tab-market" class="container screen">
    <h2 style="margin-bottom: 16px;">Live Auctions üî•</h2>
    <div id="auctionsList" class="grid">
      <div class="loader"></div>
    </div>
  </div>

  <div id="tab-gifts" class="container screen hidden">
    <h2 style="margin-bottom: 16px;">My Collection üíé</h2>
    <div id="nftsList" class="grid">
      <p style="color: #666; grid-column: 1/-1; text-align: center;">You have no items yet.</p>
    </div>
  </div>

  <div id="tab-wallet" class="container screen hidden">
    <div class="wallet-card">
      <div style="color: #8e8e93; font-size: 14px;">Total Balance</div>
      <div class="big-balance"><span id="walletBal">0.00</span> <span style="font-size: 16px; color:#8e8e93">TON</span></div>
      <div class="wallet-actions">
        <button class="action-btn" onclick="openDeposit()"><i class="ri-add-circle-line"></i> Deposit</button>
        <button class="action-btn" onclick="openWithdraw()"><i class="ri-arrow-right-up-line"></i> Withdraw</button>
      </div>
    </div>
    
    <h3>History</h3>
    <div id="txHistory" style="margin-top: 10px; color: #666; font-size: 13px;">
      No recent transactions.
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('market', this)">
      <i class="ri-store-2-line"></i>
      <span>Market</span>
    </div>
    <div class="nav-item" onclick="switchTab('gifts', this)">
      <i class="ri-vip-diamond-line"></i>
      <span>Gifts</span>
    </div>
    <div class="nav-item" onclick="switchTab('wallet', this)">
      <i class="ri-wallet-3-line"></i>
      <span>Wallet</span>
    </div>
  </div>

  <script>
    const API_URL = "https://api.growagardentrade.online"; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π –¥–æ–º–µ–Ω –∏–ª–∏ localhost –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    const tg = window.Telegram.WebApp;

    // --- Init ---
    tg.expand();
    tg.enableClosingConfirmation();
    
    // –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const state = {
      user: null,
      balance: 0
    };

    // --- API Wrapper ---
    async function api(path, method = 'GET', body = null) {
      const headers = {
        'Content-Type': 'application/json',
        'X-Telegram-Init-Data': tg.initData
      };
      try {
        const opts = { method, headers };
        if (body) opts.body = JSON.stringify(body);
        
        const res = await fetch(`${API_URL}${path}`, opts);
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Request failed');
        return json;
      } catch (e) {
        showNotif(e.message, true);
        throw e;
      }
    }

    // --- Navigation ---
    function switchTab(tabName, el) {
      document.querySelectorAll('.screen').forEach(d => d.classList.add('hidden'));
      document.getElementById('tab-' + tabName).classList.remove('hidden');
      
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      el.classList.add('active');

      if(tabName === 'market') loadAuctions();
      if(tabName === 'gifts') loadMyNfts();
      if(tabName === 'wallet') loadProfile();
    }

    // --- Core Logic ---
    async function loadProfile() {
      try {
        const res = await api('/me');
        state.user = res.user;
        state.balance = res.balance.available_ton;

        // Update UI
        document.getElementById('uName').innerText = state.user.firstName || 'User';
        document.getElementById('uAvatar').innerText = (state.user.firstName || 'U')[0];
        document.getElementById('headerBal').innerText = state.balance.toFixed(2);
        document.getElementById('walletBal').innerText = state.balance.toFixed(2);
      } catch (e) {
        console.error(e);
      }
    }

    async function loadAuctions() {
      const container = document.getElementById('auctionsList');
      container.innerHTML = '<div class="loader"></div>';
      
      try {
        const res = await api('/auctions');
        container.innerHTML = '';
        
        if (res.list.length === 0) {
            container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666; margin-top: 20px;">No active auctions</p>';
            return;
        }

        res.list.forEach(auc => {
          const div = document.createElement('div');
          div.className = 'card';
          // Placeholder –∫–∞—Ä—Ç–∏–Ω–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
          const imgUrl = auc.nft_address.includes('http') ? auc.nft_address : 'https://placehold.co/400x400/1c1c1e/FFF?text=NFT';
          
          div.innerHTML = `
            <img src="${imgUrl}" class="card-img">
            <div class="card-body">
              <div class="card-title">Gift #${auc.id}</div>
              <div class="card-price">Current: <b>${auc.current_bid} TON</b></div>
              <button class="btn btn-primary" onclick="placeBid(${auc.id}, ${auc.current_bid}, ${auc.min_increment})">
                Bid ${(auc.current_bid + auc.min_increment).toFixed(2)}
              </button>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (e) {
        container.innerText = "Error loading auctions";
      }
    }

    async function placeBid(id, current, inc) {
      const amount = current + inc; // Simple auto-increment bid
      tg.HapticFeedback.impactOccurred('medium');
      
      if(!confirm(`Bid ${amount.toFixed(2)} TON?`)) return;

      try {
        await api('/auctions/bid', 'POST', { auction_id: id, bid_amount: amount });
        showNotif('Bid Placed Successfully!');
        loadAuctions();
        loadProfile(); // update balance
      } catch (e) {
        // Error handled in api wrapper
      }
    }

    async function loadMyNfts() {
      const container = document.getElementById('nftsList');
      container.innerHTML = '<div class="loader"></div>';
      try {
        const res = await api('/nfts/my');
        container.innerHTML = '';
        if(res.items.length === 0) {
           container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666; margin-top: 40px;">Empty collection</p>';
           return;
        }
        res.items.forEach(nft => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <div style="height: 140px; background: #333; display: flex; align-items: center; justify-content: center;">NFT</div>
            <div class="card-body">
               <div class="card-title">My Item</div>
               <button class="btn btn-outline" onclick="sellNft('${nft.nft_address}')">Sell</button>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (e) {
        container.innerHTML = 'Error';
      }
    }

    // --- Wallet Actions ---
    async function openDeposit() {
      // 1. Get deposit ID
      const res = await api('/ton/deposit_invoice', 'POST', { amount: 0 });
      const comment = `DEP:${res.deposit_id}`;
      const wallet = "UQDxFs685oBQjawclpOrO-kb2n3hugWWOf51h6goSQQQLnLg"; // –¢–≤–æ–π –∫–æ—à–µ–ª–µ–∫ –∏–∑ .env
      
      tg.showPopup({
        title: 'Deposit TON',
        message: `Send TON to:\n\n${wallet.slice(0,4)}...${wallet.slice(-4)}\n\n‚ö†Ô∏è REQUIRED COMMENT:\n${comment}`,
        buttons: [{type: 'ok', text: 'Copy Comment'}]
      }, () => {
        // –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –±—É—Ñ–µ—Ä (—á–µ—Ä–µ–∑ –∫–æ—Å—Ç—ã–ª—å –∏–ª–∏ navigator)
        navigator.clipboard.writeText(comment);
        showNotif('Comment copied!');
      });
    }

    function openWithdraw() {
        const addr = prompt("Enter destination TON wallet address:");
        if(!addr) return;
        const amt = prompt("Amount to withdraw:");
        if(!amt) return;

        api('/ton/withdraw', 'POST', { amount_ton: amt, destination_wallet: addr })
         .then(() => showNotif("Withdrawal requested"))
         .catch(() => {});
    }

    function showNotif(msg, isError = false) {
      const el = document.getElementById('notification');
      el.innerText = msg;
      el.style.background = isError ? '#ff453a' : '#32d74b';
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    // Start
    loadProfile();
    loadAuctions();
  </script>
</body>
</html>
