<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AucTon</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@2.0.10/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb@0.0.66/dist/tonweb.js"></script>

    <style>
        :root {
            --bg: #0b0d12;
            --panel: #111522;
            --panel2: #0f1320;
            --text: #e7ebff;
            --muted: rgba(231,235,255,.75);
            --line: rgba(255,255,255,.10);
            --accent: #7c5cff;
            --accent2: #31d0aa;
            --danger: #ff5470;
            --shadow: 0 10px 30px rgba(0,0,0,.45);
            --r: 16px;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
            background: radial-gradient(1000px 600px at 20% -10%, rgba(124,92,255,.25), transparent 60%),
                        radial-gradient(900px 500px at 90% 0%, rgba(49,208,170,.18), transparent 55%),
                        var(--bg);
            color: var(--text);
            overflow-x: hidden;
        }
        .wrap { max-width: 980px; margin: 0 auto; padding: 16px 16px 110px; }
        .topbar {
            position: sticky; top: 0; z-index: 50;
            backdrop-filter: blur(10px);
            background: linear-gradient(to bottom, rgba(11,13,18,.92), rgba(11,13,18,.60));
            border-bottom: 1px solid var(--line);
            padding: 12px 0;
        }
        .topbar .inner {
            max-width: 980px; margin: 0 auto; padding: 0 16px;
            display: flex; align-items: center; justify-content: space-between; gap: 12px;
        }
        .brand { display: flex; align-items: center; gap: 10px; }
        .logo {
            width: 38px; height: 38px; border-radius: 12px;
            background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(49,208,170,.85));
            box-shadow: 0 10px 25px rgba(124,92,255,.25);
        }
        .brand .name { line-height: 1.05; }
        .brand .name b { display:block; font-size: 14px; letter-spacing: .2px; }
        .brand .name span { display:block; font-size: 12px; color: var(--muted); margin-top: 2px; }

        .walletArea { display:flex; align-items:center; gap: 10px; }
        .balance-pill {
            display:flex; align-items:center; gap: 10px;
            padding: 8px 10px;
            border-radius: 14px;
            background: rgba(255,255,255,.06);
            border: 1px solid var(--line);
            box-shadow: 0 10px 24px rgba(0,0,0,.25);
            min-width: 190px;
            justify-content: space-between;
        }
        .balance-left { display:flex; flex-direction: column; gap: 2px; }
        .balance-left .lbl { font-size: 11px; color: var(--muted); }
        .balance-left .val { font-weight: 700; font-size: 14px; letter-spacing: .2px; }
        .deposit-btn-mini {
            width: 34px; height: 34px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(124,92,255,.18);
            color: var(--text);
            font-weight: 800;
            cursor: pointer;
        }

        .tabs {
            display:flex; gap: 8px; margin: 16px 0 10px;
        }
        .tab {
            flex: 1;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid var(--line);
            background: rgba(255,255,255,.04);
            color: var(--muted);
            cursor: pointer;
            text-align: center;
            font-weight: 650;
        }
        .tab.active {
            color: var(--text);
            background: linear-gradient(135deg, rgba(124,92,255,.22), rgba(49,208,170,.12));
            border-color: rgba(124,92,255,.35);
            box-shadow: 0 10px 28px rgba(124,92,255,.14);
        }

        .panel {
            background: rgba(255,255,255,.04);
            border: 1px solid var(--line);
            border-radius: var(--r);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .panelHead {
            padding: 12px 14px;
            display:flex; align-items:center; justify-content: space-between;
            border-bottom: 1px solid var(--line);
            background: linear-gradient(to bottom, rgba(255,255,255,.04), rgba(255,255,255,.02));
        }
        .panelHead b { font-size: 13px; }
        .panelHead span { font-size: 12px; color: var(--muted); }

        .searchRow {
            padding: 12px 14px;
            display:flex; gap: 10px; align-items:center; flex-wrap: wrap;
            border-bottom: 1px solid var(--line);
        }
        .inp {
            flex: 1;
            min-width: 210px;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.20);
            color: var(--text);
            outline: none;
        }
        .sel {
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.20);
            color: var(--text);
            outline: none;
            min-width: 160px;
        }
        .btn {
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(255,255,255,.06);
            color: var(--text);
            cursor: pointer;
            font-weight: 700;
        }
        .btn-primary {
            background: rgba(124,92,255,.22);
            border-color: rgba(124,92,255,.35);
        }
        .btn-secondary {
            background: rgba(49,208,170,.14);
            border-color: rgba(49,208,170,.25);
        }
        .grid {
            padding: 14px;
            display:grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
        .card {
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,.10);
            background: rgba(0,0,0,.22);
            overflow: hidden;
            cursor: pointer;
            transition: transform .12s ease, border-color .12s ease;
        }
        .card:hover { transform: translateY(-2px); border-color: rgba(124,92,255,.35); }
        .thumb {
            height: 140px;
            background: rgba(255,255,255,.04);
            display:flex; align-items:center; justify-content: center;
            overflow: hidden;
        }
        .thumb img { width: 100%; height: 100%; object-fit: cover; display:block; }
        .cardBody { padding: 10px 10px 12px; }
        .title { font-weight: 800; font-size: 13px; margin-bottom: 6px; }
        .meta { font-size: 12px; color: var(--muted); display:flex; gap: 8px; flex-wrap: wrap; }
        .tag {
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(255,255,255,.05);
        }
        .priceRow { margin-top: 10px; display:flex; align-items:center; justify-content: space-between; }
        .price { font-weight: 900; }
        .time { font-size: 12px; color: var(--muted); }

        .modalBack {
            position: fixed; inset: 0;
            background: rgba(0,0,0,.55);
            display:none;
            align-items:center; justify-content:center;
            padding: 18px;
            z-index: 200;
        }
        .modal {
            width: min(520px, 100%);
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,.14);
            background: linear-gradient(180deg, rgba(17,21,34,.98), rgba(13,16,26,.96));
            box-shadow: 0 18px 60px rgba(0,0,0,.55);
            overflow:hidden;
        }
        .modalHead {
            padding: 14px 14px;
            display:flex; align-items:center; justify-content: space-between;
            border-bottom: 1px solid var(--line);
        }
        .modalHead b { font-size: 14px; }
        .close {
            width: 34px; height: 34px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(255,255,255,.06);
            color: var(--text);
            cursor: pointer;
            font-weight: 900;
        }
        .modalBody { padding: 14px; }
        .row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
        .hint { font-size: 12px; color: var(--muted); margin-top: 10px; line-height: 1.35; }

        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 90px;
            background: rgba(0,0,0,.72);
            border: 1px solid rgba(255,255,255,.14);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 14px;
            display:none;
            z-index: 500;
            max-width: min(520px, calc(100% - 30px));
        }
        .footerNav {
            position: fixed; left:0; right:0; bottom:0;
            background: rgba(11,13,18,.88);
            border-top: 1px solid var(--line);
            padding: 10px 16px;
            display:flex; gap: 10px; justify-content: center;
            backdrop-filter: blur(12px);
            z-index: 100;
        }
        .pill {
            flex: 1;
            max-width: 240px;
            padding: 12px 14px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(255,255,255,.05);
            color: var(--muted);
            font-weight: 800;
            cursor: pointer;
            text-align: center;
        }
        .pill.active {
            color: var(--text);
            background: linear-gradient(135deg, rgba(124,92,255,.20), rgba(49,208,170,.10));
            border-color: rgba(124,92,255,.35);
        }
    </style>
</head>

<body>
    <div class="topbar">
        <div class="inner">
            <div class="brand">
                <div class="logo"></div>
                <div class="name">
                    <b>AucTon</b>
                    <span>NFT auctions • TON</span>
                </div>
            </div>

            <div class="walletArea">
                <div id="tonconnect"></div>

                <div class="balance-pill">
                    <div class="balance-left">
                        <div class="lbl">Balance</div>
                        <div class="val"><span id="bal">0</span> TON</div>
                    </div>
                    <button class="deposit-btn-mini" onclick="openWalletMenu()">+</button>
                </div>
            </div>
        </div>
    </div>

    <div class="wrap">
        <div class="tabs">
            <button id="tabMarket" class="tab active" onclick="switchTab('market')">Auction</button>
            <button id="tabProfile" class="tab" onclick="switchTab('profile')">Windowaw</button>
        </div>

        <div id="marketPanel" class="panel">
            <div class="panelHead">
                <b>Active auctions</b>
                <span id="marketCount">0 items</span>
            </div>

            <div class="searchRow">
                <input id="searchMarket" class="inp" placeholder="Search by ID or name..." oninput="applyFilters()" />
                <select id="fCollection" class="sel" onchange="applyFilters()">
                    <option value="">Collection</option>
                </select>
                <select id="fModel" class="sel" onchange="applyFilters()">
                    <option value="">Model</option>
                </select>
                <select id="fBackdrop" class="sel" onchange="applyFilters()">
                    <option value="">Backdrop</option>
                </select>
                <button class="btn" onclick="load()">Refresh</button>
            </div>

            <div id="marketGrid" class="grid"></div>
        </div>

        <div id="profilePanel" class="panel" style="display:none;">
            <div class="panelHead">
                <b>Inventory</b>
                <span id="profileCount">0 items</span>
            </div>

            <div class="searchRow">
                <input id="searchProfile" class="inp" placeholder="Search by ID or name..." oninput="applyProfileFilters()" />
                <button class="btn btn-secondary" onclick="openWithdraw()">Withdraw TON</button>
                <button class="btn btn-primary" onclick="openDeposit()">Deposit TON</button>
            </div>

            <div id="profileGrid" class="grid"></div>

            <div class="panelHead" style="border-top:1px solid var(--line);">
                <b>History</b>
                <span>last 50</span>
            </div>
            <div id="history" style="padding:14px; display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>

    <div class="footerNav">
        <button id="pillMarket" class="pill active" onclick="switchTab('market')">Auction</button>
        <button id="pillProfile" class="pill" onclick="switchTab('profile')">Windowaw</button>
    </div>

    <div id="modalBack" class="modalBack" onclick="if(event.target===this) closeModal()">
        <div class="modal">
            <div class="modalHead">
                <b id="modalTitle">Modal</b>
                <button class="close" onclick="closeModal()">✕</button>
            </div>
            <div class="modalBody" id="modalBody"></div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const API = 'https://api.growagardentrade.online';
        function baseHeaders() {
            const tg = window.Telegram?.WebApp;
            const u = tg?.initDataUnsafe?.user || {};
            const h = {};
            if (u.id) h['x-user-id'] = String(u.id);
            if (tg?.initData) h['x-init-data'] = tg.initData;
            if (u.username) h['x-username'] = u.username;
            if (u.first_name) h['x-first-name'] = u.first_name;
            return h;
        }

        async function apiFetch(url, options) {
            const opt = options ? { ...options } : {};
            opt.headers = { ...baseHeaders(), ...(opt.headers || {}) };

            const r = await fetch(url, opt);
            const text = await r.text();
            try {
                return JSON.parse(text);
            } catch (e) {
                console.error('Bad JSON from', url, 'status', r.status, 'body', text.slice(0, 200));
                return { ok: false, error: 'SERVER_RETURNED_NON_JSON', status: r.status };
            }
        }

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://app.growagardentrade.online/tonconnect-manifest.json',
            buttonRootId: 'tonconnect'
        });

        let mode = 'market';
        let marketList = [];
        let profileList = [];
        let allCollections = new Set();
        let allModelsByCollection = {};
        let allBackdrops = new Set();

        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => t.style.display = 'none', 2200);
        }

        function switchTab(tab) {
            mode = tab;
            document.getElementById('marketPanel').style.display = tab === 'market' ? '' : 'none';
            document.getElementById('profilePanel').style.display = tab === 'profile' ? '' : 'none';

            document.getElementById('tabMarket').classList.toggle('active', tab === 'market');
            document.getElementById('tabProfile').classList.toggle('active', tab === 'profile');

            document.getElementById('pillMarket').classList.toggle('active', tab === 'market');
            document.getElementById('pillProfile').classList.toggle('active', tab === 'profile');
        }

        function openModal(title, html) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modalBack').style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('modalBack').style.display = 'none';
            document.getElementById('modalBody').innerHTML = '';
        }

        function timeLeft(ts) {
            const ms = ts - Date.now();
            if (ms <= 0) return 'ended';
            const s = Math.floor(ms / 1000);
            const d = Math.floor(s / 86400);
            const h = Math.floor((s % 86400) / 3600);
            const m = Math.floor((s % 3600) / 60);
            if (d > 0) return `${d}d ${h}h`;
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }

        function parseAttrs(attributes) {
            let attrs = [];
            try {
                if (typeof attributes === 'string') attrs = JSON.parse(attributes);
                else if (Array.isArray(attributes)) attrs = attributes;
            } catch (e) {}
            const out = { Collection: '', Model: '', Background: '' };
            for (const a of attrs) {
                if (!a) continue;
                const k = (a.trait_type || a.key || '').toString();
                const v = (a.value || '').toString();
                if (!k || !v) continue;
                if (k.toLowerCase() === 'collection') out.Collection = v;
                if (k.toLowerCase() === 'model') out.Model = v;
                if (k.toLowerCase() === 'background' || k.toLowerCase() === 'backdrop') out.Background = v;
            }
            return out;
        }

        function buildFiltersFromList(list) {
            allCollections = new Set();
            allModelsByCollection = {};
            allBackdrops = new Set();

            for (const item of list) {
                const traits = parseAttrs(item.attributes);
                item.parsedTraits = traits;

                if (traits.Collection) {
                    allCollections.add(traits.Collection);
                    if (!allModelsByCollection[traits.Collection]) allModelsByCollection[traits.Collection] = new Set();
                    if (traits.Model) allModelsByCollection[traits.Collection].add(traits.Model);
                }
                if (traits.Background) allBackdrops.add(traits.Background);
            }

            const colSel = document.getElementById('fCollection');
            const modelSel = document.getElementById('fModel');
            const backSel = document.getElementById('fBackdrop');

            const colVal = colSel.value;
            colSel.innerHTML = `<option value="">Collection</option>` + [...allCollections].sort().map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('');
            if ([...allCollections].includes(colVal)) colSel.value = colVal;

            const selectedCollection = colSel.value;
            const models = selectedCollection && allModelsByCollection[selectedCollection] ? [...allModelsByCollection[selectedCollection]].sort() : [];
            const modelVal = modelSel.value;
            modelSel.innerHTML = `<option value="">Model</option>` + models.map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('');
            if (models.includes(modelVal)) modelSel.value = modelVal;

            const backVal = backSel.value;
            backSel.innerHTML = `<option value="">Backdrop</option>` + [...allBackdrops].sort().map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('');
            if ([...allBackdrops].includes(backVal)) backSel.value = backVal;
        }

        function escapeHtml(s) {
            return (s || '').toString()
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function renderGrid(list, targetId, isMarket) {
            const grid = document.getElementById(targetId);
            if (!list.length) {
                grid.innerHTML = `<div style="padding:12px;color:var(--muted);">Empty</div>`;
                return;
            }

            grid.innerHTML = list.map(item => {
                const traits = item.parsedTraits || parseAttrs(item.attributes);
                const tags = [
                    traits.Collection ? `<span class="tag">${escapeHtml(traits.Collection)}</span>` : '',
                    traits.Model ? `<span class="tag">${escapeHtml(traits.Model)}</span>` : '',
                    traits.Background ? `<span class="tag">${escapeHtml(traits.Background)}</span>` : ''
                ].join('');

                const price = isMarket ? (Number(item.current_bid || 0).toFixed(2)) : '';
                const time = isMarket ? timeLeft(item.ends_at) : '';

                return `
                    <div class="card" onclick="${isMarket ? `openAuction(${item.id}, ${Number(item.current_bid || 0)}, '${escapeHtml(item.name || '')}')` : `openNftActions(${item.id}, '${escapeHtml(item.name || '')}')`}">
                        <div class="thumb">
                            <img src="${escapeHtml(item.image_url || '')}" onerror="this.style.display='none';this.parentNode.innerHTML='<span style=\\'color:var(--muted)\\'>no image</span>';">
                        </div>
                        <div class="cardBody">
                            <div class="title">#${item.id} ${escapeHtml(item.name || '')}</div>
                            <div class="meta">${tags}</div>
                            <div class="priceRow">
                                <div class="price">${isMarket ? `${price} TON` : ''}</div>
                                <div class="time">${isMarket ? time : ''}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function applyFilters() {
            const q = document.getElementById('searchMarket').value.trim().toLowerCase();
            const c = document.getElementById('fCollection').value;
            const m = document.getElementById('fModel').value;
            const b = document.getElementById('fBackdrop').value;

            const filtered = marketList.filter(x => {
                const name = (x.name || '').toLowerCase();
                const id = String(x.id);
                const traits = x.parsedTraits || parseAttrs(x.attributes);

                if (q && !(name.includes(q) || id.includes(q))) return false;
                if (c && traits.Collection !== c) return false;
                if (m && traits.Model !== m) return false;
                if (b && traits.Background !== b) return false;
                return true;
            });

            document.getElementById('marketCount').textContent = `${filtered.length} items`;
            renderGrid(filtered, 'marketGrid', true);

            const colSel = document.getElementById('fCollection');
            const modelSel = document.getElementById('fModel');
            const selectedCollection = colSel.value;

            const models = selectedCollection && allModelsByCollection[selectedCollection] ? [...allModelsByCollection[selectedCollection]].sort() : [];
            const modelVal = modelSel.value;
            modelSel.innerHTML = `<option value="">Model</option>` + models.map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('');
            if (models.includes(modelVal)) modelSel.value = modelVal;
            else modelSel.value = '';
        }

        function applyProfileFilters() {
            const q = document.getElementById('searchProfile').value.trim().toLowerCase();
            const filtered = profileList.filter(x => {
                const name = (x.name || '').toLowerCase();
                const id = String(x.id);
                if (q && !(name.includes(q) || id.includes(q))) return false;
                return true;
            });

            document.getElementById('profileCount').textContent = `${filtered.length} items`;
            renderGrid(filtered, 'profileGrid', false);
        }

        function openAuction(id, price, name) {
            openModal(`Auction #${id}`, `
                <div class="row" style="justify-content:space-between;">
                    <div>
                        <div style="font-size:12px;color:var(--muted);">Current bid</div>
                        <div style="font-size:18px;font-weight:900;">${Number(price||0).toFixed(2)} TON</div>
                    </div>
                    <button class="btn btn-primary" onclick="placeBid(${id}, ${Number(price||0)})">Bid</button>
                </div>
                <div class="hint">Min step: 1 TON • If bid in last minute — extends 1 minute</div>
            `);
        }

        async function placeBid(auctionId, price) {
            closeModal();
            openModal(`Bid #${auctionId}`, `
                <div class="row">
                    <input id="bidAmount" class="inp" style="min-width:160px;" type="number" value="${(price + 1).toFixed(0)}" step="1" min="${Math.max(1, Math.ceil(price + 1))}">
                    <button class="btn btn-primary" onclick="confirmBid(${auctionId})">Confirm</button>
                </div>
                <div class="hint">Bid will lock TON until someone outbids you or auction ends.</div>
            `);
        }

        async function confirmBid(auctionId) {
            const v = Number(document.getElementById('bidAmount').value);
            if (!v || v <= 0) return toast('Bad amount');

            const res = await apiFetch(`${API}/api/auction/bid`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auctionId, amount: v })
            });

            if (!res.ok) return toast(res.error || 'Bid failed');
            toast('Bid placed');
            closeModal();
            await load();
        }

        function openNftActions(nftId, name) {
            openModal(`NFT #${nftId}`, `
                <div class="row" style="justify-content:space-between;">
                    <button class="btn btn-primary" onclick="createAuction(${nftId})">List on auction</button>
                    <button class="btn btn-secondary" onclick="withdrawNft(${nftId})">Withdraw NFT (0.2 TON)</button>
                </div>
                <div class="hint">${escapeHtml(name || '')}</div>
            `);
        }

        function createAuction(nftId) {
            closeModal();
            openModal(`Create auction`, `
                <div class="row">
                    <input id="startPrice" class="inp" style="min-width:160px;" type="number" step="1" min="1" value="1">
                    <button class="btn btn-primary" onclick="confirmCreateAuction(${nftId})">Create</button>
                </div>
                <div class="hint">Duration is fixed: 5 days • Min bid: 1 TON • Min step: 1 TON</div>
            `);
        }

        async function confirmCreateAuction(nftId) {
            const price = Number(document.getElementById('startPrice').value);
            const res = await apiFetch(`${API}/api/auction/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nftId, price })
            });
            if (!res.ok) return toast(res.error || 'Create failed');
            toast('Auction created');
            closeModal();
            await load();
            switchTab('market');
        }

        async function withdrawNft(nftId) {
            const res = await apiFetch(`${API}/api/withdraw/nft`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nftId })
            });
            if (!res.ok) return toast(res.error || 'Withdraw request failed');
            toast('Withdraw requested');
            closeModal();
            await load();
        }

        function openWalletMenu() {
            openModal("TON", `
                <div style="display:flex; gap:12px; margin-top:12px;">
                    <button class="btn btn-primary" style="margin-top:0;" onclick="openDeposit()">Пополнение TON</button>
                    <button class="btn btn-secondary" style="margin-top:0;" onclick="openWithdraw()">Вывод TON</button>
                </div>
            `);
        }

        function openDeposit() {
            openModal('Deposit TON', `
                <div class="hint">Connect wallet and send TON to deposit wallet. After transfer it will be credited automatically.</div>
                <div style="margin-top:10px;" class="row">
                    <button class="btn btn-primary" onclick="sendDeposit()">Open payment</button>
                </div>
            `);
        }

        function openWithdraw() {
            openModal('Withdraw TON', `
                <div class="row">
                    <input id="wAmount" class="inp" placeholder="Amount TON" type="number" step="0.01" min="0.01">
                    <input id="wAddress" class="inp" placeholder="Address (UQ...)" style="min-width:260px;">
                </div>
                <div style="margin-top:10px;" class="row">
                    <button class="btn btn-primary" onclick="confirmWithdraw()">Create request</button>
                </div>
                <div class="hint">Withdraw is queued and processed by admin.</div>
            `);
        }

        async function confirmWithdraw() {
            const amount = Number(document.getElementById('wAmount').value);
            const address = (document.getElementById('wAddress').value || '').trim();
            if (!amount || amount <= 0) return toast('Bad amount');
            if (address.length < 10) return toast('Bad address');

            const res = await apiFetch(`${API}/api/withdraw/ton`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount, address })
            });

            if (!res.ok) return toast(res.error || 'Withdraw failed');
            toast('Withdraw requested');
            closeModal();
            await load();
        }

        async function sendDeposit() {
            try {
                await tonConnectUI.openModal();
                const w = tonConnectUI.wallet;
                if (!w) return toast('Wallet not connected');

                const u = tg.initDataUnsafe.user;
                if (!u || !u.id) return toast('No Telegram user');

                const amount = prompt('Enter TON amount to deposit:', '1');
                if (!amount) return;

                const toNano = (x) => {
                    const n = Number(x);
                    if (!Number.isFinite(n) || n <= 0) throw new Error('bad amount');
                    return (n * 1e9).toFixed(0);
                };

                const bodyCell = new TonWeb.boc.Cell();
                bodyCell.bits.writeUint(0, 32);
                bodyCell.bits.writeString(String(u.id));
                const payload = TonWeb.utils.bytesToBase64(await bodyCell.toBoc(false));

                await tonConnectUI.sendTransaction({
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [{
                        address: 'UQDxFs685oBQjawclpOrO-kb2n3hugWWOf51h6goSQQQLnLg',
                        amount: toNano(amount),
                        payload
                    }]
                });

                toast('Payment sent, waiting credit...');
                closeModal();
            } catch (e) {
                console.error(e);
                toast('Payment canceled');
            }
        }

        function renderHistory(list) {
            const box = document.getElementById('history');
            if (!list || !list.length) {
                box.innerHTML = `<div style="color:var(--muted);">No history</div>`;
                return;
            }
            box.innerHTML = list.map(x => {
                const t = new Date(x.created_at).toLocaleString();
                return `
                    <div class="panel" style="padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.03);">
                        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
                            <b style="font-size:13px;">${escapeHtml(x.type)}</b>
                            <span style="color:var(--muted);font-size:12px;">${t}</span>
                        </div>
                        <div style="margin-top:6px;font-weight:900;">${Number(x.amount).toFixed(6)} TON</div>
                    </div>
                `;
            }).join('');
        }

        async function load() {
            const user = tg.initDataUnsafe.user;

            const resUser = await apiFetch(`${API}/api/user`, { headers: { 'x-user-id': user?.id || '' } });
            if (!resUser.ok) return toast(resUser.error || 'User load failed');

            document.getElementById('bal').textContent = Number(resUser.balance || 0).toFixed(3);

            profileList = (resUser.nfts || []).map(item => {
                item.parsedTraits = parseAttrs(item.attributes);
                return item;
            });
            document.getElementById('profileCount').textContent = `${profileList.length} items`;
            renderGrid(profileList, 'profileGrid', false);
            renderHistory(resUser.history || []);

            const res = await apiFetch(`${API}/api/auctions`);
            if (!res.ok) return toast(res.error || 'Auctions load failed');

            marketList = (res.list || []).map(item => {
                item.parsedTraits = parseAttrs(item.attributes);
                return item;
            });

            buildFiltersFromList(marketList);
            document.getElementById('marketCount').textContent = `${marketList.length} items`;
            renderGrid(marketList, 'marketGrid', true);

            applyFilters();
            applyProfileFilters();
        }

        load().catch(e => {
            console.error(e);
            toast('Init error');
        });
    </script>
</body>
</html>
