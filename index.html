<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Auction</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0f0f11;
            --card-bg: rgba(30, 30, 35, 0.8);
            --primary: #0098ea; /* TON Blue */
            --accent: #ffb300;
            --text: #ffffff;
            --text-sec: #8e8e93;
            --glass: blur(12px);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 90px; /* Space for bottom nav */
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Header & Wallet --- */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(15, 15, 17, 0.8);
            backdrop-filter: var(--glass);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .user-bal {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .ton-icon { width: 18px; height: 18px; }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Containers --- */
        .container { padding: 16px; animation: fadeIn 0.4s ease-out; }
        .hidden { display: none !important; }

        /* --- Grid & Cards --- */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); }

        .card-img-wrap {
            width: 100%;
            aspect-ratio: 1;
            background: #2c2c2e;
            position: relative;
        }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-body { padding: 10px; }
        .card-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .card-price { font-size: 12px; color: var(--text-sec); }
        .price-val { font-size: 14px; color: var(--primary); font-weight: 700; }

        /* --- Buttons --- */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            margin-top: 8px;
            cursor: pointer;
        }
        .btn-outline { background: rgba(255,255,255,0.1); }

        /* --- Bottom Nav --- */
        .nav {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 60px;
            background: rgba(40, 40, 45, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 50;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-item {
            color: var(--text-sec);
            font-size: 24px;
            transition: 0.3s;
            position: relative;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; 
            transform: translateX(-50%); width: 4px; height: 4px; 
            background: var(--primary); border-radius: 50%;
        }

        /* --- Loader --- */
        .loader-wrap { display: flex; justify-content: center; padding: 40px; }
        .spinner {
            width: 30px; height: 30px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="header">
        <div class="user-bal">
            <span id="username">User</span>
            <span style="margin: 0 6px; opacity: 0.3;">|</span>
            <span id="balance">0.00</span> TON
        </div>
        <div id="ton-connect"></div>
    </div>

    <div id="tab-market" class="container">
        <h2 style="margin: 0 0 16px 0; font-size: 22px;">Live Auctions üî•</h2>
        <div id="market-list" class="grid"></div>
        <div id="market-loader" class="loader-wrap"><div class="spinner"></div></div>
    </div>

    <div id="tab-gifts" class="container hidden">
        <h2 style="margin: 0 0 16px 0; font-size: 22px;">My Collection üíé</h2>
        <div id="gifts-list" class="grid"></div>
        <div id="gifts-loader" class="loader-wrap hidden"><div class="spinner"></div></div>
    </div>

    <div id="tab-profile" class="container hidden">
        <h2 style="margin: 0 0 16px 0;">Wallet üëõ</h2>
        <div style="background: linear-gradient(135deg, #1c1c1e, #2c2c2e); padding: 20px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05);">
            <div style="color: #8e8e93; font-size: 13px;">Available Balance</div>
            <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">
                <span id="profile-bal">0.00</span> TON
            </div>
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button class="btn" style="background: #32d74b;" onclick="deposit()">Deposit</button>
                <button class="btn btn-outline" onclick="withdraw()">Withdraw</button>
            </div>
            <p style="font-size: 11px; color: #666; margin-top: 12px;">Withdraw fee: 0.2 TON</p>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="switchTab('market', this)"><i class="ri-store-2-fill"></i></div>
        <div class="nav-item" onclick="switchTab('gifts', this)"><i class="ri-vip-diamond-fill"></i></div>
        <div class="nav-item" onclick="switchTab('profile', this)"><i class="ri-wallet-3-fill"></i></div>
    </div>

    <script>
        // --- CONFIG ---
        const API_URL = "https://api.growagardentrade.online"; 
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TonConnect
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://app.growagardentrade.online/tonconnect-manifest.json', // –°–æ–∑–¥–∞–π —ç—Ç–æ—Ç —Ñ–∞–π–ª!
            buttonRootId: 'ton-connect'
        });

        // --- API HELPERS ---
        async function api(path, method = 'GET', body = null) {
            try {
                const res = await fetch(`${API_URL}${path}`, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': tg.initData
                    },
                    body: body ? JSON.stringify(body) : null
                });
                if (!res.ok) throw new Error(`Server Error: ${res.status}`);
                return await res.json();
            } catch (e) {
                console.error(e);
                tg.showAlert("Connection error. Try again later.");
                return null;
            }
        }

        // --- LOGIC ---
        async function init() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            const user = tg.initDataUnsafe.user;
            if(user) {
                document.getElementById('username').innerText = user.first_name;
            }
            loadData();
        }

        async function loadData() {
            const data = await api('/me'); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–ª–∞–Ω—Å
            if (data && data.balance) {
                const bal = data.balance.available_ton.toFixed(2);
                document.getElementById('balance').innerText = bal;
                document.getElementById('profile-bal').innerText = bal;
            }
            loadAuctions();
        }

        async function loadAuctions() {
            const list = document.getElementById('market-list');
            document.getElementById('market-loader').classList.remove('hidden');
            
            const res = await api('/auctions');
            document.getElementById('market-loader').classList.add('hidden');
            list.innerHTML = '';

            if(!res || !res.list || res.list.length === 0) {
                list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #555; margin-top: 20px;">No active auctions</div>';
                return;
            }

            res.list.forEach(item => {
                const el = document.createElement('div');
                el.className = 'card';
                // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∞
                const img = item.nft_address.includes('http') ? item.nft_address : 'https://placehold.co/400/1e1e1e/FFF?text=NFT';
                
                el.innerHTML = `
                    <div class="card-img-wrap"><img src="${img}" class="card-img"></div>
                    <div class="card-body">
                        <div class="card-title">Lot #${item.id}</div>
                        <div class="card-price">Current Bid</div>
                        <div class="price-val">${item.current_bid} TON</div>
                        <button class="btn" onclick="bid(${item.id})">Bid +1 TON</button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');

            if(tab === 'market') loadAuctions();
        }

        async function bid(id) {
            tg.HapticFeedback.impactOccurred('medium');
            if(!confirm("Place a bid? +1 TON")) return;
            
            const res = await api('/auctions/bid', 'POST', { auction_id: id });
            if(res && res.ok) {
                tg.showAlert("Success! You are the leader.");
                loadAuctions();
                loadData(); // Update balance
            } else {
                tg.showAlert("Failed: " + (res?.error || "Unknown error"));
            }
        }

        function deposit() {
            tg.showPopup({
                title: 'Deposit',
                message: 'Send TON to the wallet address provided by the bot.',
                buttons: [{type: 'ok'}]
            });
        }

        function withdraw() {
            const addr = prompt("Enter your TON Wallet address:");
            if(addr) api('/ton/withdraw', 'POST', { address: addr });
        }

        // Start
        init();

    </script>
</body>
</html>
