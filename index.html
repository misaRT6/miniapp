<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Auction</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body { font-family: sans-serif; background: #0b0e11; color: #eaecef; margin: 0; padding-bottom: 70px; }
        .container { padding: 15px; display: none; }
        .active { display: block; }
        .card { background: #1e2329; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #30363d; }
        .nft-img { width: 100%; border-radius: 8px; }
        .btn { background: #f0b90b; border: none; color: #000; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-outline { background: transparent; color: #f0b90b; border: 1px solid #f0b90b; }
        .nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #181a20; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #30363d; }
        .nav i { font-size: 22px; color: #848e9c; }
        .nav .active-nav { color: #f0b90b; }
        input { width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #474d57; background: #1e2329; color: #fff; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="tab-market" class="container active">
        <h3 style="color: #f0b90b">Аукционы (5 дней)</h3>
        <div id="market-list"></div>
    </div>

    <div id="tab-wallet" class="container">
        <h3>Кошелек</h3>
        <div class="card">
            <div id="user-balance" style="font-size: 24px; font-weight: bold;">0.00 TON</div>
            <input type="number" id="dep-amount" placeholder="Сумма пополнения">
            <button class="btn" onclick="deposit()">Пополнить через кошелек</button>
            <hr style="border-color: #30363d; margin: 15px 0;">
            <input type="text" id="with-address" placeholder="Адрес кошелька">
            <input type="number" id="with-amount" placeholder="Сумма вывода">
            <button class="btn btn-outline" onclick="withdrawTon()">Вывести TON</button>
        </div>
        <div id="ton-connect" style="display: flex; justify-content: center;"></div>
    </div>

    <div id="tab-profile" class="container">
        <h3>Мои NFT</h3>
        <div id="my-nfts"></div>
    </div>

    <div class="nav">
        <i class="ri-fire-line active-nav" onclick="switchTab('market', this)"></i>
        <i class="ri-wallet-2-line" onclick="switchTab('wallet', this)"></i>
        <i class="ri-user-3-line" onclick="switchTab('profile', this)"></i>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: 'https://app.growagardentrade.online/tonconnect-manifest.json', buttonRootId: 'ton-connect' });
        const API = "https://api.growagardentrade.online/api";
        const userId = tg.initDataUnsafe.user?.id || 0;

        async function load() {
            const res = await fetch(`${API}/me?userId=${userId}`).then(r => r.json());
            if (res.ok) {
                document.getElementById('user-balance').innerText = res.balance.toFixed(2) + " TON";
                renderNfts(res.nfts);
            }
            fetch(`${API}/auctions`).then(r => r.json()).then(res => {
                const cont = document.getElementById('market-list');
                cont.innerHTML = '';
                res.list?.forEach(a => {
                    const timeLeft = Math.max(0, Math.floor((a.ends_at - Date.now()) / 3600000));
                    cont.innerHTML += `<div class="card"><img src="${a.nft_address}" class="nft-img"><b>${a.current_bid} TON</b><br><small>Осталось: ${timeLeft}ч.</small><button class="btn">Сделать ставку</button></div>`;
                });
            });
        }

        function renderNfts(nfts) {
            const cont = document.getElementById('my-nfts');
            cont.innerHTML = nfts.length ? '' : 'Нет доступных NFT';
            nfts.forEach(n => {
                cont.innerHTML += `
                    <div class="card">
                        <img src="${n.nft_address}" class="nft-img">
                        <input type="number" id="bid-${n.id}" placeholder="Мин. ставка TON">
                        <button class="btn" onclick="listNft(${n.id})">На аукцион (5д)</button>
                        <button class="btn btn-outline" onclick="withdrawNft(${n.id})">Вывести на кошелек</button>
                    </div>`;
            });
        }

        async function listNft(nftId) {
            const minBid = document.getElementById(`bid-${nftId}`).value;
            if(!minBid) return alert("Укажите цену");
            await fetch(`${API}/list-auction`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId, nftId, minBid }) });
            alert("Выставлено!"); load();
        }

        async function withdrawNft(nftId) {
            const wallet = tonConnectUI.account?.address || prompt("Введите адрес кошелька:");
            if(!wallet) return;
            await fetch(`${API}/request-nft-withdraw`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId, nftId, wallet }) });
            alert("Заявка отправлена админу!"); load();
        }

        async function withdrawTon() {
            const amount = document.getElementById('with-amount').value;
            const wallet = document.getElementById('with-address').value;
            const res = await fetch(`${API}/withdraw-ton`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId, amount, wallet }) }).then(r => r.json());
            alert(res.ok ? "Заявка на TON отправлена!" : "Ошибка: " + res.error); load();
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.nav i').forEach(i => i.classList.remove('active-nav'));
            el.classList.add('active-nav');
        }

        load();
    </script>
</body>
</html>
