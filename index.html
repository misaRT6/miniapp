<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Gifts Wallet</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    body{margin:0;background:#0b0b0f;color:#f2f3f5;font-family:system-ui}
    .wrap{max-width:420px;margin:0 auto;padding:16px}
    .card{background:#121219;border-radius:20px;padding:16px}
    .btn{width:100%;padding:14px;border-radius:14px;border:none;font-weight:700}
    .btn.primary{background:#2f6bff;color:#fff}
    .input{width:100%;padding:12px;border-radius:12px;border:none;margin:10px 0}
    .muted{opacity:.6;font-size:13px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Wallet</h2>
    <div id="tonconnect-button"></div>
    <div style="font-size:36px;font-weight:800" id="bal">0 TON</div>
    <div class="muted">Deposit via TON Connect (Telegram Wallet)</div>
    <input id="amt" class="input" placeholder="Amount TON" />
    <button class="btn primary" onclick="deposit()">Deposit</button>
    <pre id="dbg"></pre>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp; tg.ready();
const API = "https://api.growagardentrade.online";
const DEPOSIT_WALLET = "UQDxFs685oBQjawclpOrO-kb2n3hugWWOf51h6goSQQQLnLg";

const tc = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: "https://app.growagardentrade.online/tonconnect-manifest.json",
  buttonRootId: "tonconnect-button"
});

async function api(path, body){
  const r = await fetch(API+path,{
    method:"POST",
    headers:{
      "Authorization": tg.initData,
      "Content-Type":"application/json"
    },
    body:JSON.stringify(body)
  });
  return r.json();
}

async function refresh(){
  const r = await fetch(API+"/me",{headers:{Authorization:tg.initData}});
  const j = await r.json();
  document.getElementById("bal").textContent = j.balance.available_ton+" TON";
}
refresh();

async function deposit(){
  try{
    const amt = Number(document.getElementById("amt").value);
    const r = await api("/deposit/request",{amount_ton:amt});
    await tc.sendTransaction({
      validUntil: Math.floor(Date.now()/1000)+600,
      messages:[{
        address: DEPOSIT_WALLET,
        amount: String(Math.floor(amt*1e9)),
        payload: r.comment
      }]
    });
    setTimeout(refresh,5000);
  }catch(e){
    document.getElementById("dbg").textContent = e.toString();
  }
}
</script>
</body>
</html>
