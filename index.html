<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Gifts</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    :root{
      --bg:#07080c;
      --card:#0f1118;
      --card2:#111421;
      --stroke:rgba(255,255,255,.08);
      --text:#f2f4ff;
      --muted:rgba(242,244,255,.62);
      --accent:#2f6bff;
      --good:#35d07f;
      --warn:#ffcc66;
      --bad:#ff5d5d;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:420px;margin:0 auto;padding:14px 14px 110px}
    .row{display:flex;gap:10px;align-items:center}
    .space{justify-content:space-between}
    .title{font-size:18px;font-weight:800;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:12px}
    .card{background:linear-gradient(180deg,var(--card),rgba(15,17,24,.75));border:1px solid var(--stroke);border-radius:var(--radius);padding:14px}
    .card2{background:var(--card2);border:1px solid var(--stroke);border-radius:var(--radius);padding:12px}
    .big{font-size:40px;font-weight:900;line-height:1}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;color:var(--muted)}
    .btn{width:100%;border:none;border-radius:14px;padding:13px 12px;font-weight:800}
    .btn.primary{background:var(--accent);color:white}
    .btn.ghost{background:transparent;border:1px solid var(--stroke);color:var(--text)}
    .btn.warn{background:rgba(255,204,102,.14);border:1px solid rgba(255,204,102,.25);color:var(--text)}
    .btn:active{transform:translateY(1px)}
    input,select{width:100%;background:#0b0d14;border:1px solid var(--stroke);color:var(--text);padding:12px;border-radius:14px;outline:none}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .gifts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .gift{background:#0b0d14;border:1px solid var(--stroke);border-radius:16px;padding:12px;min-height:86px;display:flex;flex-direction:column;justify-content:space-between}
    .gift .name{font-weight:800;font-size:13px}
    .gift .meta{font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .section{margin-top:12px}
    .tabs{display:flex;gap:8px}
    .tab{flex:1;text-align:center;padding:10px;border-radius:14px;border:1px solid var(--stroke);background:transparent;color:var(--muted);font-weight:800}
    .tab.on{background:#0b0d14;color:var(--text)}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .item{display:flex;justify-content:space-between;align-items:center;background:#0b0d14;border:1px solid var(--stroke);border-radius:14px;padding:10px}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--stroke);color:var(--muted)}
    .badge.good{border-color:rgba(53,208,127,.35);color:rgba(53,208,127,.9)}
    .badge.warn{border-color:rgba(255,204,102,.35);color:rgba(255,204,102,.9)}
    .badge.bad{border-color:rgba(255,93,93,.35);color:rgba(255,93,93,.9)}
    .footerbar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(7,8,12,.92);backdrop-filter:blur(12px);
      border-top:1px solid var(--stroke);
      padding:10px;
    }
    .footwrap{max-width:420px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    pre{white-space:pre-wrap;color:var(--muted);font-size:12px;margin:8px 0 0}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row space">
      <div>
        <div class="title">Gifts</div>
        <div class="muted" id="subtitle">Wallet • gifts storage</div>
      </div>
      <div id="tonconnect-button"></div>
    </div>

    <div class="section card">
      <div class="row space">
        <div>
          <div class="muted">Available</div>
          <div class="big" id="bal">—</div>
        </div>
        <div style="text-align:right">
          <div class="pill" id="userpill">not authorized</div>
          <div class="muted" style="margin-top:6px">Network: TON</div>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <button class="btn primary" onclick="openDeposit()">Deposit</button>
        <button class="btn ghost" onclick="openWithdraw()">Withdraw</button>
      </div>
    </div>

    <div class="section card2" id="panel-deposit" style="display:none">
      <div class="row space">
        <div style="font-weight:900">Deposit TON</div>
        <div class="badge warn" id="depStatus">ready</div>
      </div>
      <div class="muted" style="margin-top:6px">You will confirm transaction in your wallet.</div>

      <div style="margin-top:10px">
        <input id="depAmount" inputmode="decimal" placeholder="Amount (TON), e.g. 3" />
      </div>
      <div class="grid" style="margin-top:10px">
        <button class="btn primary" onclick="startDeposit()">Pay</button>
        <button class="btn ghost" onclick="closePanels()">Close</button>
      </div>

      <pre id="depHint"></pre>
    </div>

    <div class="section card2" id="panel-withdraw" style="display:none">
      <div class="row space">
        <div style="font-weight:900">Withdraw TON</div>
        <div class="badge warn">manual payout</div>
      </div>
      <div class="muted" style="margin-top:6px">Creates a request. Admin processes it manually.</div>

      <div style="margin-top:10px">
        <input id="wdAmount" inputmode="decimal" placeholder="Amount (TON)" />
      </div>
      <div style="margin-top:10px">
        <input id="wdAddr" placeholder="Destination wallet address" />
      </div>
      <div class="grid" style="margin-top:10px">
        <button class="btn warn" onclick="createWithdraw()">Create request</button>
        <button class="btn ghost" onclick="closePanels()">Close</button>
      </div>

      <pre id="wdHint"></pre>
    </div>

    <div class="section">
      <div class="row space">
        <div style="font-weight:900">My gifts</div>
        <div class="muted" id="giftCount">0</div>
      </div>
      <div class="gifts" id="gifts"></div>
    </div>

    <div class="section">
      <div class="row space">
        <div style="font-weight:900">History</div>
        <div class="tabs" style="width:180px">
          <button class="tab on" id="tab-activity" onclick="switchTab('activity')">Activity</button>
          <button class="tab" id="tab-deposits" onclick="switchTab('deposits')">Deposits</button>
        </div>
      </div>

      <div class="list" id="list"></div>
    </div>

    <pre id="dbg"></pre>
  </div>

  <div class="footerbar">
    <div class="footwrap">
      <button class="btn ghost" onclick="refreshAll()">Refresh</button>
      <button class="btn primary" onclick="tgExpand()">Expand</button>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const API = "https://api.growagardentrade.online";
  const DEPOSIT_WALLET = "UQDxFs685oBQjawclpOrO-kb2n3hugWWOf51h6goSQQQLnLg";
  const MANIFEST_URL = "https://app.growagardentrade.online/tonconnect-manifest.json";

  // ====== TELEGRAM ======
  const tg = window.Telegram.WebApp;
  tg.ready();

  function tgExpand(){ try{ tg.expand(); }catch(e){} }

  // ====== TON CONNECT ======
  const tc = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: MANIFEST_URL,
    buttonRootId: "tonconnect-button"
  });

  // ====== SAFE API WRAPPER ======
  async function api(path, method="GET", body=null){
    const initData = tg.initData;
    if (!initData) throw new Error("initData empty: open via bot Mini App button");

    const opt = { method, headers: { "Authorization": initData } };
    if(body){
      opt.headers["Content-Type"] = "application/json";
      opt.body = JSON.stringify(body);
    }

    const r = await fetch(API + path, opt);
    const text = await r.text();

    let data;
    try { data = JSON.parse(text); }
    catch {
      throw new Error(`NON-JSON (${r.status}) from ${API + path}:\n` + text.slice(0, 300));
    }

    if(!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);
    return data;
  }

  // ====== UI HELPERS ======
  function setDbg(msg){ document.getElementById("dbg").textContent = msg || ""; }
  function show(id, yes){ document.getElementById(id).style.display = yes ? "block" : "none"; }

  function openDeposit(){ show("panel-deposit", true); show("panel-withdraw", false); setDbg(""); }
  function openWithdraw(){ show("panel-withdraw", true); show("panel-deposit", false); setDbg(""); }
  function closePanels(){ show("panel-deposit", false); show("panel-withdraw", false); setDbg(""); }

  function badgeForStatus(s){
    if(s === "confirmed") return ["good", "confirmed"];
    if(s === "pending") return ["warn", "pending"];
    if(s === "paid") return ["good", "paid"];
    if(s === "rejected") return ["bad", "rejected"];
    if(s === "expired") return ["bad", "expired"];
    return ["warn", String(s || "—")];
  }

  // ====== DATA LOAD ======
  let currentTab = "activity";

  async function refreshMe(){
    const j = await api("/me");
    document.getElementById("bal").textContent = (j.balance?.available_ton ?? "0") + " TON";
    document.getElementById("userpill").textContent = "@" + (j.user?.username || ("id" + j.user.telegram_user_id));

    const gifts = j.my_nfts || [];
    document.getElementById("giftCount").textContent = gifts.length + " items";
    const box = document.getElementById("gifts");
    box.innerHTML = "";

    if(!gifts.length){
      box.innerHTML = `<div class="muted">No gifts yet</div>`;
      return;
    }

    for(const g of gifts){
      const short = (g.nft_address || "").slice(0, 10) + "…" + (g.nft_address || "").slice(-6);
      const el = document.createElement("div");
      el.className = "gift";
      el.innerHTML = `
        <div>
          <div class="name">Gift</div>
          <div class="meta">${short}</div>
        </div>
        <div class="row space">
          <span class="badge">${g.status}</span>
          <button class="btn ghost" style="width:auto;padding:8px 10px;border-radius:12px" onclick="withdrawGift('${g.nft_address}')">Withdraw</button>
        </div>
      `;
      box.appendChild(el);
    }
  }

  async function refreshList(){
    const list = document.getElementById("list");
    list.innerHTML = "";

    if(currentTab === "activity"){
      const j = await api("/my/activity");
      const items = j.items || [];
      if(!items.length){
        list.innerHTML = `<div class="muted">No activity</div>`;
        return;
      }
      for(const it of items){
        const [cls, label] = badgeForStatus(it.status);
        const left = `${it.type.toUpperCase()} • ${Number(it.amount_ton).toFixed(3)} TON`;
        const right = label;
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <div style="font-weight:800">${left}</div>
            <div class="muted">${new Date(it.created_at).toLocaleString()}</div>
          </div>
          <span class="badge ${cls}">${right}</span>
        `;
        list.appendChild(el);
      }
      return;
    }

    if(currentTab === "deposits"){
      const j = await api("/my/deposits");
      const items = j.items || [];
      if(!items.length){
        list.innerHTML = `<div class="muted">No deposits</div>`;
        return;
      }
      for(const it of items){
        const [cls, label] = badgeForStatus(it.status);
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <div style="font-weight:800">${Number(it.amount_ton).toFixed(3)} TON</div>
            <div class="muted">${it.id}</div>
          </div>
          <span class="badge ${cls}">${label}</span>
        `;
        list.appendChild(el);
      }
    }
  }

  function switchTab(t){
    currentTab = t;
    document.getElementById("tab-activity").classList.toggle("on", t === "activity");
    document.getElementById("tab-deposits").classList.toggle("on", t === "deposits");
    refreshList().catch(e => setDbg(String(e)));
  }

  async function refreshAll(){
    try{
      setDbg("");
      await refreshMe();
      await refreshList();
    }catch(e){
      setDbg(String(e));
    }
  }

  // ====== ACTIONS ======
  async function startDeposit(){
    try{
      setDbg("");
      const amt = Number(String(document.getElementById("depAmount").value).replace(",", "."));
      if(!(amt > 0)) throw new Error("Enter amount > 0");

      document.getElementById("depStatus").textContent = "creating…";

      const dep = await api("/deposit/request", "POST", { amount_ton: amt });

      const payload = dep.comment;              // DEP:<uuid>
      const nano = String(Math.floor(amt * 1e9));

      document.getElementById("depHint").textContent =
        `Send ${amt} TON\nTo: ${dep.deposit_wallet}\nComment: ${payload}`;

      document.getElementById("depStatus").textContent = "confirm in wallet…";

      await tc.sendTransaction({
        validUntil: Math.floor(Date.now()/1000) + 600,
        messages: [{
          address: DEPOSIT_WALLET,
          amount: nano,
          payload: payload
        }]
      });

      // Poll status by new endpoint: /deposit/status?id=...
      document.getElementById("depStatus").textContent = "checking…";
      await pollDeposit(dep.deposit_id);

      await refreshAll();
      document.getElementById("depStatus").textContent = "done";
    }catch(e){
      document.getElementById("depStatus").textContent = "error";
      setDbg(String(e));
    }
  }

  async function pollDeposit(depositId){
    const started = Date.now();
    while(Date.now() - started < 60000){
      const s = await api(`/deposit/status?id=${encodeURIComponent(depositId)}`, "GET");
      const st = s.status;
      const [cls, label] = badgeForStatus(st);
      const el = document.getElementById("depStatus");
      el.className = "badge " + cls;
      el.textContent = label;

      if(st === "confirmed") return true;
      await new Promise(r => setTimeout(r, 2500));
    }
    throw new Error("Deposit not confirmed yet (wait and press Refresh)");
  }

  async function createWithdraw(){
    try{
      setDbg("");
      const amt = Number(String(document.getElementById("wdAmount").value).replace(",", "."));
      const addr = String(document.getElementById("wdAddr").value || "").trim();
      if(!(amt > 0)) throw new Error("Enter amount > 0");
      if(!addr) throw new Error("Enter destination wallet");

      const j = await api("/ton/withdraw", "POST", { amount_ton: amt, destination_wallet: addr });
      document.getElementById("wdHint").textContent = `Request created: #${j.withdrawal_id}`;
      await refreshAll();
    }catch(e){
      setDbg(String(e));
    }
  }

  async function withdrawGift(nftAddr){
    try{
      setDbg("");
      const dest = prompt("Destination wallet for NFT withdraw:");
      if(!dest) return;
      const j = await api("/nft/withdraw", "POST", { nft_address: nftAddr, destination_wallet: dest });
      setDbg("NFT marked for withdraw. Fee charged: " + j.charged_ton + " TON");
      await refreshAll();
    }catch(e){
      setDbg(String(e));
    }
  }

  // ====== INIT ======
  refreshAll();
</script>
</body>
</html>
